<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Evro Zbiratelj Album</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        
        body {
             font-family: 'Inter', system-ui, -apple-system, sans-serif;
             -webkit-tap-highlight-color: transparent;
        }
        
        /* Premium prehodi */
        .card-hover { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .card-hover:active { transform: scale(0.96); }
        
        /* Navigacija na dnu za mobilne naprave */
        .bottom-nav { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Skrijemo scrollbar, ohranimo funkcionalnost */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 pb-24">

    <!-- Glavna nadzorna plo≈°ƒça -->
    <header class="bg-slate-900 text-white pt-8 pb-8 px-4 sm:px-6 md:px-8 rounded-b-[2rem] shadow-xl relative overflow-hidden border-b-4 border-blue-500 z-10">
        <div class="absolute top-0 right-0 opacity-5 pointer-events-none transform translate-x-1/4 -translate-y-1/4">
            <i data-lucide="layout-grid" class="w-[300px] h-[300px]" stroke-width="1.5"></i>
        </div>
        
        <div class="max-w-5xl mx-auto relative z-10">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl md:text-4xl font-black flex items-center gap-2 tracking-tight">
                        <i data-lucide="euro" class="text-blue-400 drop-shadow-md w-8 h-8"></i>
                        Evro Album
                    </h1>
                    <!-- Indikator oblaka -->
                    <div id="cloud-indicator" class="mt-1 inline-flex items-center gap-1.5 px-2 py-0.5 bg-green-500/10 border border-green-500/20 rounded-full text-[10px] font-bold text-green-400 uppercase tracking-widest opacity-0 transition-opacity duration-500">
                        <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
                        V oblaku: <span id="header-sync-code" class="font-mono text-white">...</span>
                    </div>
                </div>
                
                <!-- Znaƒçka za skupno vrednost -->
                <div class="bg-gradient-to-r from-blue-600 to-blue-500 text-white px-4 py-2 rounded-2xl shadow-lg font-black text-xl flex items-center justify-center gap-2 border border-blue-400">
                    <i data-lucide="wallet" class="w-5 h-5 opacity-90"></i>
                    <span id="total-value">‚Ç¨0.00</span>
                </div>
            </div>

            <!-- Statistika napredka -->
            <div class="grid grid-cols-2 gap-4">
                
                <!-- Redni kovanci (Dr≈æave) -->
                <div class="bg-white/10 backdrop-blur-md border border-white/10 rounded-2xl p-4 shadow-inner relative overflow-hidden">
                    <div class="text-blue-200 font-bold text-[10px] uppercase tracking-widest flex items-center gap-1 mb-2">
                        <i data-lucide="flag" class="w-3 h-3"></i> Osvojene dr≈æave
                    </div>
                    <div class="flex items-baseline gap-1 mb-2">
                        <div class="text-3xl font-black text-white leading-none" id="reg-collected">0</div>
                        <div class="text-sm text-slate-400 font-bold">/ 25</div>
                    </div>
                    <div class="w-full bg-slate-800 rounded-full h-2 overflow-hidden shadow-inner">
                        <div id="reg-bar" class="bg-blue-400 h-full transition-all duration-700 ease-out" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Slovenski spominski kovanci -->
                <div class="bg-white/10 backdrop-blur-md border border-white/10 rounded-2xl p-4 shadow-inner relative overflow-hidden">
                    <div class="text-blue-200 font-bold text-[10px] uppercase tracking-widest flex items-center gap-1 mb-2">
                        <i data-lucide="star" class="w-3 h-3"></i> SLO Spominski
                    </div>
                    <div class="flex items-baseline gap-1 mb-2">
                        <div class="text-3xl font-black text-white leading-none" id="sl-collected">0</div>
                        <div class="text-sm text-slate-400 font-bold">/ <span id="sl-total">0</span></div>
                    </div>
                    <div class="w-full bg-slate-800 rounded-full h-2 overflow-hidden shadow-inner flex">
                        <div id="sl-bar-white" class="bg-white h-full transition-all duration-700 ease-out" style="width: 0%"></div>
                        <div id="sl-bar-blue" class="bg-blue-500 h-full transition-all duration-700 ease-out" style="width: 0%"></div>
                        <div id="sl-bar-red" class="bg-red-500 h-full transition-all duration-700 ease-out" style="width: 0%"></div>
                    </div>
                </div>

            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 sm:px-6 md:px-8 mt-6">

        <!-- ZAVIHEK 1: DR≈ΩAVE (Zdru≈æene serije) -->
        <section id="view-countries" class="block animate-in fade-in duration-300">
            <div class="mb-4 flex items-center justify-between">
                <div>
                    <h3 class="text-xl font-black tracking-tight text-slate-800">Redni kovanci</h3>
                    <p class="text-xs text-slate-500 font-medium">Tapni dr≈æavo za pregled serij</p>
                </div>
            </div>

            <!-- Mre≈æa 25 Dr≈æav -->
            <div id="countries-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-3 md:gap-4">
                <!-- Generirano z JS -->
            </div>
        </section>

        <!-- ZAVIHEK 2: SLOVENIJA (ƒåasovnica) -->
        <section id="view-timeline" class="hidden animate-in fade-in duration-300">
            <div class="mb-4 flex items-center justify-between">
                <div>
                    <h3 class="text-xl font-black tracking-tight text-slate-800">SLO Spominski</h3>
                    <p class="text-xs text-slate-500 font-medium">Posebne izdaje po letih</p>
                </div>
                <!-- Gumb za kompaktni pogled -->
                <button onclick="toggleCompactMode()" class="px-3 py-2 bg-slate-200/60 hover:bg-slate-200 rounded-xl text-slate-600 transition-colors flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest shadow-sm active:scale-95">
                    <i data-lucide="layout-grid" id="compact-icon" class="w-4 h-4"></i>
                    <span id="compact-text">Zgosti</span>
                </button>
            </div>

            <div id="slo-grid" class="pb-4">
                <!-- Generirano z JS -->
            </div>
        </section>

    </main>

    <!-- Mobilna Spodnja Navigacija -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-lg border-t border-slate-200 shadow-[0_-10px_30px_rgba(0,0,0,0.05)] z-40 bottom-nav flex justify-around items-center px-1 pt-2 pb-2 transition-transform">
        <button id="tab-countries" onclick="switchView('countries')" class="flex-1 flex flex-col items-center gap-1 p-2 text-blue-600 font-bold transition-all">
            <div class="bg-blue-100 p-1.5 rounded-xl"><i data-lucide="layout-grid" class="w-5 h-5"></i></div>
            <span class="text-[10px] uppercase tracking-wider">Dr≈æave</span>
        </button>
        <button id="tab-timeline" onclick="switchView('timeline')" class="flex-1 flex flex-col items-center gap-1 p-2 text-slate-400 font-medium transition-all">
            <div class="bg-transparent p-1.5 rounded-xl"><i data-lucide="clock" class="w-5 h-5"></i></div>
            <span class="text-[10px] uppercase tracking-wider">Slovenija</span>
        </button>
        
        <!-- NOV ZAVIHEK: OBLAK (Firebase Sync) in Nastavitve -->
        <button onclick="openSyncModal()" class="flex-1 flex flex-col items-center gap-1 p-2 text-slate-400 font-medium hover:text-blue-500 transition-all group relative">
            <div class="bg-transparent group-hover:bg-blue-50 p-1.5 rounded-xl transition-colors relative">
                <i data-lucide="cloud" class="w-5 h-5"></i>
                <!-- Pika za aktivno povezavo -->
                <div id="nav-cloud-dot" class="absolute top-1 right-1 w-2.5 h-2.5 bg-green-500 border-2 border-white rounded-full hidden"></div>
            </div>
            <span class="text-[10px] uppercase tracking-wider">Oblak</span>
        </button>
    </nav>

    <!-- JavaScript Logika & Firebase Integracija -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. PODATKOVNA BAZA ---
        const COINS = [
            // REDNI KOVANCI
            { id: 'reg-ad', type: 'Regular', year: 'Redna izdaja', country: 'Andora', flag: 'üá¶üá©', title: 'Redni 2‚Ç¨ - Grb Andore', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2_%E2%82%AC_Andorra.jpg', description: 'Prikazuje grb Andore z nacionalnim geslom.' },
            { id: 'reg-at', type: 'Regular', year: 'Redna izdaja', country: 'Avstrija', flag: 'üá¶üáπ', title: 'Redni 2‚Ç¨ - Bertha von Suttner', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2e_oes.png', description: 'Prikazuje portret Berthe von Suttner, dobitnice Nobelove nagrade za mir.' },
            { id: 'reg-be-1', type: 'Regular', year: '1. serija (1999-2007)', country: 'Belgija', flag: 'üáßüá™', title: 'Redni 2‚Ç¨ - Kralj Albert II', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2e_bel.png', description: 'Prikazuje portret kralja Alberta II.' },
            { id: 'reg-be-2', type: 'Regular', year: '2. serija (2008-2013)', country: 'Belgija', flag: 'üáßüá™', title: 'Redni 2‚Ç¨ - Kralj Albert II', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/Belgium_2euro_2008.jpg', description: 'Posodobljen portret kralja Alberta II.' },
            { id: 'reg-be-3', type: 'Regular', year: '3. serija (od 2014)', country: 'Belgija', flag: 'üáßüá™', title: 'Redni 2‚Ç¨ - Kralj Filip', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/Belgium_2euro_2014ph.jpg', description: 'Prikazuje portret belgijskega kralja Filipa.' },
            { id: 'reg-bg', type: 'Regular', year: 'Redna izdaja', country: 'Bolgarija', flag: 'üáßüá¨', title: 'Redni 2‚Ç¨ - Pajsij Hilendarski', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/Bulgaria_2euro.jpg', description: 'Prikazuje Pajsija Hilendarskega.' },
            { id: 'reg-hr', type: 'Regular', year: 'Redna izdaja', country: 'Hrva≈°ka', flag: 'üá≠üá∑', title: 'Redni 2‚Ç¨ - Zemljevid Hrva≈°ke', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/Croatia_2euro.jpg', description: 'Prikazuje geografski zemljevid Republike Hrva≈°ke.' },
            { id: 'reg-cy', type: 'Regular', year: 'Redna izdaja', country: 'Ciper', flag: 'üá®üáæ', title: 'Redni 2‚Ç¨ - Idol iz Pomosa', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2_%E2%82%AC_Cipro.gif', description: 'Prikazuje idol v obliki kri≈æa iz bakrene dobe.' },
            { id: 'reg-ee', type: 'Regular', year: 'Redna izdaja', country: 'Estonija', flag: 'üá™üá™', title: 'Redni 2‚Ç¨ - Zemljevid Estonije', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2_%E2%82%AC_Estonia.jpg', description: 'Prikazuje geografski zemljevid Estonije v obrisu.' },
            { id: 'reg-fi', type: 'Regular', year: 'Redna izdaja', country: 'Finska', flag: 'üá´üáÆ', title: 'Redni 2‚Ç¨ - Barjevska robida', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2e_fin.png', description: 'Prikazuje sade≈æ in liste barjevske robide.' },
            { id: 'reg-fr-1', type: 'Regular', year: '1. serija (do 2021)', country: 'Francija', flag: 'üá´üá∑', title: 'Redni 2‚Ç¨ - Drevo ≈æivljenja', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2e_fra.png', description: 'Prikazuje drevo, ujeto v ≈°esterokotnik.' },
            { id: 'reg-fr-2', type: 'Regular', year: '2. serija (od 2022)', country: 'Francija', flag: 'üá´üá∑', title: 'Redni 2‚Ç¨ - Hrast in oljka', imageUrl: 'https://de.wikipedia.org/wiki/Special:FilePath/PFUE2022_-_2_euros_(cropped).jpg', description: 'Prikazuje prepletene veje hrasta in oljke.' },
            { id: 'reg-de', type: 'Regular', year: 'Redna izdaja', country: 'Nemƒçija', flag: 'üá©üá™', title: 'Redni 2‚Ç¨ - Nem≈°ki orel', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2e_ger.png', description: 'Prikazuje tradicionalni simbol nem≈°ke suverenosti, heraldiƒçnega orla.' },
            { id: 'reg-gr', type: 'Regular', year: 'Redna izdaja', country: 'Grƒçija', flag: 'üá¨üá∑', title: 'Redni 2‚Ç¨ - Evropa in bik', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2_%E2%82%AC_Grecia.gif', description: 'Prikazuje prizor iz mitologije, kjer Zevs ugrabi Evropo.' },
            { id: 'reg-ie', type: 'Regular', year: 'Redna izdaja', country: 'Irska', flag: 'üáÆüá™', title: 'Redni 2‚Ç¨ - Keltska harfa', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2_euro_Irlanda.jpg', description: 'Prikazuje keltsko harfo, tradicionalni simbol Irske.' },
            { id: 'reg-it', type: 'Regular', year: 'Redna izdaja', country: 'Italija', flag: 'üáÆüáπ', title: 'Redni 2‚Ç¨ - Dante Alighieri', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2_%E2%82%AC_Italia.jpg', description: 'Prikazuje portret slovitega italijanskega pesnika Danteja Alighierija.' },
            { id: 'reg-lv', type: 'Regular', year: 'Redna izdaja', country: 'Latvija', flag: 'üá±üáª', title: 'Redni 2‚Ç¨ - Latvijska deklica', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2_eur_LV.jpg', description: 'Prikazuje profil latvijske deklice, prvotno na srebrniku iz leta 1929.' },
            { id: 'reg-lt', type: 'Regular', year: 'Redna izdaja', country: 'Litva', flag: 'üá±üáπ', title: 'Redni 2‚Ç¨ - Vytis (Vitez)', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/Lituania_%E2%82%AC2.jpg', description: 'Prikazuje Vytisa, juna≈°kega viteza na konju.' },
            { id: 'reg-lu', type: 'Regular', year: 'Redna izdaja', country: 'Luksemburg', flag: 'üá±üá∫', title: 'Redni 2‚Ç¨ - Veliki vojvoda Henri', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2_%E2%82%AC_Lussemburgo.jpg', description: 'Prikazuje portret velikega vojvode Henrija.' },
            { id: 'reg-mt', type: 'Regular', year: 'Redna izdaja', country: 'Malta', flag: 'üá≤üáπ', title: 'Redni 2‚Ç¨ - Malte≈°ki kri≈æ', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2_Euro_Malta.jpg', description: 'Prikazuje osemkraki malte≈°ki kri≈æ.' },
            { id: 'reg-mc-1', type: 'Regular', year: '1. serija', country: 'Monako', flag: 'üá≤üá®', title: 'Redni 2‚Ç¨ - Knez Rainier III', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2_%E2%82%AC_Monaco_2001.jpg', description: 'Prikazuje kneza Rainierja III.' },
            { id: 'reg-mc-2', type: 'Regular', year: '2. serija', country: 'Monako', flag: 'üá≤üá®', title: 'Redni 2‚Ç¨ - Knez Albert II', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2_%E2%82%AC_Monaco_2006.jpg', description: 'Prikazuje portret kneza Alberta II.' },
            { id: 'reg-nl-1', type: 'Regular', year: '1. serija', country: 'Nizozemska', flag: 'üá≥üá±', title: 'Redni 2‚Ç¨ - Kraljica Beatrix', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2e_nl.png', description: 'Prikazuje profil nizozemske kraljice Beatrix.' },
            { id: 'reg-nl-2', type: 'Regular', year: '2. serija', country: 'Nizozemska', flag: 'üá≥üá±', title: 'Redni 2‚Ç¨ - Kralj Willem-Alexander', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2_%E2%82%AC_Paesi_Bassi_serie_2014.jpg', description: 'Prikazuje fasetiran portret kralja Willema-Alexandra.' },
            { id: 'reg-pt', type: 'Regular', year: 'Redna izdaja', country: 'Portugalska', flag: 'üáµüáπ', title: 'Redni 2‚Ç¨ - Kraljevi peƒçati', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2e_por.png', description: 'Prikazuje kraljevi peƒçat iz leta 1144.' },
            { id: 'reg-sm', type: 'Regular', year: 'Redna izdaja', country: 'San Marino', flag: 'üá∏üá≤', title: 'Redni 2‚Ç¨ - Vladna palaƒça', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2_%E2%82%AC_San_Marino.gif', description: 'Prikazuje palaƒço Palazzo Pubblico.' },
            { id: 'reg-sk', type: 'Regular', year: 'Redna izdaja', country: 'Slova≈°ka', flag: 'üá∏üá∞', title: 'Redni 2‚Ç¨ - Dvojni kri≈æ na hribih', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2_%E2%82%AC_Slovacchia.png', description: 'Prikazuje dr≈æavni grb - dvojni kri≈æ.' },
            { id: 'reg-si', type: 'Regular', year: 'Redna izdaja', country: 'Slovenija', flag: 'üá∏üáÆ', title: 'Redni 2‚Ç¨ - France Pre≈°eren', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/Si2.1eur.jpg', description: 'Prikazuje profil najveƒçjega slovenskega pesnika Franceta Pre≈°erna.' },
            { id: 'reg-es-1', type: 'Regular', year: '1. serija', country: '≈†panija', flag: 'üá™üá∏', title: 'Redni 2‚Ç¨ - Kralj Juan Carlos I', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2_%E2%82%AC_Spagna.gif', description: 'Prikazuje portret ≈°panskega kralja Juana Carlosa I.' },
            { id: 'reg-es-2', type: 'Regular', year: '2. serija', country: '≈†panija', flag: 'üá™üá∏', title: 'Redni 2‚Ç¨ - Juan Carlos I (posodobljen)', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/Spain_2euro_2014.jpg', description: 'Posodobljen portret v skladu z novimi pravili EU.' },
            { id: 'reg-es-3', type: 'Regular', year: '3. serija', country: '≈†panija', flag: 'üá™üá∏', title: 'Redni 2‚Ç¨ - Kralj Filip VI', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/Spain_2euro_2015.jpg', description: 'Prikazuje portret kralja Filipa VI.' },
            { id: 'reg-va-1', type: 'Regular', year: '1. serija', country: 'Vatikan', flag: 'üáªüá¶', title: 'Redni 2‚Ç¨ - Pape≈æ Janez Pavel II', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2_euro_coin_Va_serie_1.png', description: 'Prikazuje profil pape≈æa Janeza Pavla II.' },
            { id: 'reg-va-2', type: 'Regular', year: '2. serija', country: 'Vatikan', flag: 'üáªüá¶', title: 'Redni 2‚Ç¨ - Sede Vacante', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2_euro_coin_Va_serie_2.png', description: 'Izdana v ƒçasu Sede Vacante (praznega sede≈æa).' },
            { id: 'reg-va-3', type: 'Regular', year: '3. serija', country: 'Vatikan', flag: 'üáªüá¶', title: 'Redni 2‚Ç¨ - Pape≈æ Benedikt XVI', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2_euro_coin_Va_serie_3a.png', description: 'Prikazuje profil pape≈æa Benedikta XVI.' },
            { id: 'reg-va-4', type: 'Regular', year: '4. serija', country: 'Vatikan', flag: 'üáªüá¶', title: 'Redni 2‚Ç¨ - Pape≈æ Franƒçi≈°ek', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2_%E2%82%AC_Vaticano_2014.png', description: 'Prikazuje profil pape≈æa Franƒçi≈°ka.' },
            { id: 'reg-va-5', type: 'Regular', year: '5. serija', country: 'Vatikan', flag: 'üáªüá¶', title: 'Redni 2‚Ç¨ - Pape≈°ki grb', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2_euros_Vatican5.png', description: 'Portret zamenja grb suverena Vatikana.' },

            // SLOVENSKI SPOMINSKI KOVANCI
            { id: 'sl-2007-rome', type: 'Commemorative', year: 2007, country: 'Slovenija', flag: 'üá∏üáÆ', title: '50. obletnica Rimske pogodbe', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/%E2%82%AC2_commemorative_coin_Slovenia_2007_TOR.jpg', description: 'Skupna evropska izdaja. Dokument pogodbe s podpisi.' },
            { id: 'sl-2008-trubar', type: 'Commemorative', year: 2008, country: 'Slovenija', flag: 'üá∏üáÆ', title: '500 let rojstva Primo≈æa Trubarja', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2-eur_Trubar2008.png', description: 'Profil Primo≈æa Trubarja. Vkljuƒçuje citat "Stati inu obstati".' },
            { id: 'sl-2009-emu', type: 'Commemorative', year: 2009, country: 'Slovenija', flag: 'üá∏üáÆ', title: '10 let EMU', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2-eur_EMU2009.png', description: 'Skupna izdaja. Primitivna ƒçlove≈°ka figura s simbolom ‚Ç¨.' },
            { id: 'sl-2010-botanical', type: 'Commemorative', year: 2010, country: 'Slovenija', flag: 'üá∏üáÆ', title: '200 let Botaniƒçnega vrta', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2-eur_Botani%C4%8Dni_vrt2010.png', description: 'Cvet rastline rebrinƒçevolistna hladnikovka.' },
            { id: 'sl-2011-rozman', type: 'Commemorative', year: 2011, country: 'Slovenija', flag: 'üá∏üáÆ', title: '100 let rojstva Franca Rozmana', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2-eur_Stane2011.png', description: 'Stiliziran portret narodnega heroja s petokrako zvezdo.' },
            { id: 'sl-2012-euro', type: 'Commemorative', year: 2012, country: 'Slovenija', flag: 'üá∏üáÆ', title: '10 let evrskih gotovinskih plaƒçil', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2-eur_evrogotovina2012.png', description: 'Skupna izdaja ob 10. obletnici evro bankovcev in kovancev.' },
            { id: 'sl-2013-postojna', type: 'Commemorative', year: 2013, country: 'Slovenija', flag: 'üá∏üáÆ', title: '800 let obiska Postojnske jame', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2-eur_Postojnska2013.png', description: 'Stilizirana spirala, ki predstavlja podzemne prehode.' },
            { id: 'sl-2014-barbara', type: 'Commemorative', year: 2014, country: 'Slovenija', flag: 'üá∏üáÆ', title: '600 let kronanja Barbare Celjske', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2-eur_Barbara2014.png', description: 'Portret Barbare Celjske z ≈æezlom in tremi zvezdami.' },
            { id: 'sl-2015-emona', type: 'Commemorative', year: 2015, country: 'Slovenija', flag: 'üá∏üáÆ', title: '2000 let Emone (Ljubljane)', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2-eur_Emona2015.png', description: 'Geometrijski liki in ƒçrke, ki tvorijo besedo EMONA.' },
            { id: 'sl-2015-euflag', type: 'Commemorative', year: 2015, country: 'Slovenija', flag: 'üá∏üáÆ', title: '30 let zastave EU', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2-eur_zastavaEU2015.png', description: 'Skupna izdaja. Zvezde, ki se preminjajo v ljudi.' },
            { id: 'sl-2016-independence', type: 'Commemorative', year: 2016, country: 'Slovenija', flag: 'üá∏üáÆ', title: '25 let neodvisnosti RS', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2-eur_osamosvojitev2016.png', description: 'Diagonalno vrezan verz iz Pre≈°ernove Zdravljice.' },
            { id: 'sl-2017-euro10', type: 'Commemorative', year: 2017, country: 'Slovenija', flag: 'üá∏üáÆ', title: '10 let evra v Sloveniji', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2-eur_evro2017.png', description: 'Deset leteƒçih lastovk v krogu.' },
            { id: 'sl-2018-bees', type: 'Commemorative', year: 2018, country: 'Slovenija', flag: 'üá∏üáÆ', title: 'Svetovni dan ƒçebel', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2-eur_%C4%8Debele2018.png', description: 'Globus v obliki satja. Slovenska iniciativa OZN.' },
            { id: 'sl-2019-uni', type: 'Commemorative', year: 2019, country: 'Slovenija', flag: 'üá∏üáÆ', title: '100 let Univerze v Ljubljani', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2-eur_Uni-LJ2019.png', description: 'Osrednje proƒçelje glavne stavbe Univerze.' },
            { id: 'sl-2020-bohoric', type: 'Commemorative', year: 2020, country: 'Slovenija', flag: 'üá∏üáÆ', title: '500 let rojstva Adama Bohoriƒça', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2-eur_Bohori%C4%8D2020.png', description: 'Veƒçjeziƒçni napis iz njegove slovnice Arcticae horulae.' },
            { id: 'sl-2021-museum', type: 'Commemorative', year: 2021, country: 'Slovenija', flag: 'üá∏üáÆ', title: '200 let Narodnega muzeja', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2-eur_muzej2021.png', description: 'Ilustracija znamenite Va≈°ke situle.' },
            { id: 'sl-2022-plecnik', type: 'Commemorative', year: 2022, country: 'Slovenija', flag: 'üá∏üáÆ', title: '150 let rojstva Jo≈æeta Pleƒçnika', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2-eur_plecnik2022.png', description: 'Detajl z velikega okna ƒçitalnice NUK v Ljubljani.' },
            { id: 'sl-2022-erasmus', type: 'Commemorative', year: 2022, country: 'Slovenija', flag: 'üá∏üáÆ', title: '35 let programa Erasmus', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2-eur_erasmus2022.png', description: 'Skupna izdaja. Portret Erazma Rotterdamskega.' },
            { id: 'sl-2023-plemelj', type: 'Commemorative', year: 2023, country: 'Slovenija', flag: 'üá∏üáÆ', title: '150 let rojstva Josipa Plemlja', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2-eur_Plemelj2023.png', description: 'Enaƒçba in grafiƒçne oblike matematiƒçnega dela.' },
            { id: 'sl-2024-library', type: 'Commemorative', year: 2024, country: 'Slovenija', flag: 'üá∏üáÆ', title: '250 let NUK', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2-eur_NUK2024.png', description: 'Obele≈æitev obletnice Narodne in univerzitetne knji≈ænice.' },
            { id: 'sl-2025-miki', type: 'Commemorative', year: 2025, country: 'Slovenija', flag: 'üá∏üáÆ', title: '100 let rojstva Mikija Mustra', imageUrl: 'https://sl.wikipedia.org/wiki/Special:FilePath/2-eur_Muster2025.png', description: 'Pionir slovenskega stripa, animator in ilustrator.' },
            { id: 'sl-2026-cankar', type: 'Commemorative', year: 2026, country: 'Slovenija', flag: 'üá∏üáÆ', title: '150 let rojstva Ivana Cankarja', imageUrl: 'https://upload.wikimedia.org/wikipedia/it/7/7e/2_euro_commemorativo_2026_slovenia_cankar.webp', description: 'Pisatelj in dramatik, ki je globoko zaznamoval literaturo.' }
        ];

        const regularCoins = COINS.filter(c => c.type === 'Regular');
        const UNIQUE_COUNTRIES = [...new Set(regularCoins.map(c => c.country))];
        
        let collectedCoins = {};

        // --- 2. FIREBASE INTEGRACIJA & STATE MANAGEMENT ---
        const firebaseConfig = {
            apiKey: "AIzaSyC5uqhPfv_q1dx9xMk4VnWu6wq7AOKmjB8",
            authDomain: "delo-ae21b.firebaseapp.com",
            projectId: "delo-ae21b",
            storageBucket: "delo-ae21b.firebasestorage.app",
            messagingSenderId: "721173225350",
            appId: "1:721173225350:web:83926980686c6f4ec11607",
            measurementId: "G-4STZTWDQ1X"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let authUser = null;
        let unsubscribeSnapshot = null;

        // Sinhronizacijska koda
        let currentSyncCode = localStorage.getItem('euro_sync_code');
        if (!currentSyncCode) {
            currentSyncCode = Math.random().toString(36).substring(2, 8).toUpperCase();
            localStorage.setItem('euro_sync_code', currentSyncCode);
        }

        // Prednalo≈æi offline podatke (ƒçe ni interneta)
        try {
            const localData = localStorage.getItem('euro-collection-v4');
            if (localData) collectedCoins = JSON.parse(localData);
        } catch(e) {}

        // Centralna funkcija za shranjevanje baze
        async function saveData() {
            // Shrani lokalno za hitrej≈°e delovanje
            try { localStorage.setItem('euro-collection-v4', JSON.stringify(collectedCoins)); } catch (e) {}
            
            // Shrani v Firebase za soƒçasno uporabo
            if (!authUser) return;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'euro_collections', currentSyncCode), {
                    coins: collectedCoins,
                    updatedAt: new Date().toISOString()
                });
            } catch (err) {
                console.error("Napaka pri shranjevanju v oblak:", err);
            }
            renderApp();
            refreshOpenModal();
        }

        function refreshOpenModal() {
            const modalTitle = document.getElementById('modal-title').innerText;
            if (modalTitle && UNIQUE_COUNTRIES.includes(modalTitle) && document.getElementById('coin-modal').classList.contains('opacity-0') === false) {
                openCountryModal(modalTitle);
            }
        }

        function updateCloudUI() {
            const headerCode = document.getElementById('header-sync-code');
            const cloudInd = document.getElementById('cloud-indicator');
            const navDot = document.getElementById('nav-cloud-dot');
            if (headerCode) headerCode.innerText = currentSyncCode;
            if (cloudInd) cloudInd.classList.remove('opacity-0');
            if (navDot) navDot.classList.remove('hidden');
        }

        function listenToCollection(code) {
            if (unsubscribeSnapshot) unsubscribeSnapshot();

            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'euro_collections', code);
            unsubscribeSnapshot = onSnapshot(docRef, (docSnap) => {
                updateCloudUI(); // Poka≈æe da smo povezani
                if (docSnap.exists()) {
                    collectedCoins = docSnap.data().coins || {};
                    try { localStorage.setItem('euro-collection-v4', JSON.stringify(collectedCoins)); } catch (e) {}
                    renderApp();
                    refreshOpenModal();
                } else {
                    // Oblak je prazen. ƒåe imamo lokalne podatke, jih nalo≈æimo v nov oblak
                    if (Object.keys(collectedCoins).length > 0) {
                        saveData();
                    } else {
                        collectedCoins = {};
                        renderApp();
                        refreshOpenModal();
                    }
                }
            }, (error) => {
                console.error("Napaka pri branju iz oblaka:", error);
            });
        }

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Napaka pri prijavi:", e);
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                authUser = user;
                listenToCollection(currentSyncCode);
            } else {
                authUser = null;
            }
        });

        // Po≈æeni prijavo
        initAuth();

        // --- IZPOSTAVITEV FUNKCIJ V WINDOW ZA HTML KLIC ---
        window.switchView = switchView;
        window.resetCollection = resetCollection;
        window.hideResetConfirm = hideResetConfirm;
        window.executeReset = executeReset;
        window.openZoom = openZoom;
        window.closeZoom = closeZoom;
        window.toggleCoin = toggleCoin;
        window.toggleCondition = toggleCondition;
        window.openCountryModal = openCountryModal;
        window.closeModal = closeModal;
        window.openSyncModal = openSyncModal;
        window.closeSyncModal = closeSyncModal;
        window.loadFromCode = loadFromCode;
        window.generateRandomCode = generateRandomCode;

        // Stanje za kompaktni pogled
        let compactMode = localStorage.getItem('euro_compact_mode') === 'true';

        window.toggleCompactMode = function() {
            compactMode = !compactMode;
            localStorage.setItem('euro_compact_mode', compactMode);
            renderSloGrid();
            lucide.createIcons();
        }

        function toggleCoin(id) {
            if (collectedCoins[id]) {
                delete collectedCoins[id];
            } else {
                collectedCoins[id] = 'mint';
            }
            saveData();
        }

        function toggleCondition(id, e) {
            e.stopPropagation(); 
            if (collectedCoins[id]) {
                collectedCoins[id] = collectedCoins[id] === 'mint' ? 'poor' : 'mint';
                saveData();
            }
        }

        // --- BRISANJE ZBIRKE ---
        function resetCollection() {
            const modal = document.getElementById('confirm-modal');
            const content = document.getElementById('confirm-modal-content');
            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            });
        }

        function hideResetConfirm() {
            const modal = document.getElementById('confirm-modal');
            const content = document.getElementById('confirm-modal-content');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        function executeReset() {
            collectedCoins = {}; 
            saveData();
            hideResetConfirm();
        }

        // --- ZOOM SLIKE ---
        function openZoom(imageUrl, title) {
            document.getElementById('zoom-image').src = imageUrl;
            document.getElementById('zoom-title').innerText = title;
            const modal = document.getElementById('zoom-modal');
            modal.classList.remove('hidden');
            lucide.createIcons();
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
            });
        }

        function closeZoom() {
            const modal = document.getElementById('zoom-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        // --- TAB NAVIGACIJA ---
        function switchView(viewName) {
            document.getElementById('view-countries').style.display = viewName === 'countries' ? 'block' : 'none';
            document.getElementById('view-timeline').style.display = viewName === 'timeline' ? 'block' : 'none';
            
            const tabC = document.getElementById('tab-countries');
            const tabT = document.getElementById('tab-timeline');
            
            if(viewName === 'countries') {
                tabC.className = 'flex-1 flex flex-col items-center gap-1 p-2 text-blue-600 font-bold transition-all';
                tabC.querySelector('div').className = 'bg-blue-100 p-1.5 rounded-xl';
                tabT.className = 'flex-1 flex flex-col items-center gap-1 p-2 text-slate-400 font-medium transition-all';
                tabT.querySelector('div').className = 'bg-transparent p-1.5 rounded-xl';
            } else {
                tabT.className = 'flex-1 flex flex-col items-center gap-1 p-2 text-blue-600 font-bold transition-all';
                tabT.querySelector('div').className = 'bg-blue-100 p-1.5 rounded-xl';
                tabC.className = 'flex-1 flex flex-col items-center gap-1 p-2 text-slate-400 font-medium transition-all';
                tabC.querySelector('div').className = 'bg-transparent p-1.5 rounded-xl';
            }
        }

        function getFlagImg(countryName) {
            const map = {
                'Andora': 'ad', 'Avstrija': 'at', 'Belgija': 'be', 'Bolgarija': 'bg', 'Hrva≈°ka': 'hr',
                'Ciper': 'cy', 'Estonija': 'ee', 'Finska': 'fi', 'Francija': 'fr', 'Nemƒçija': 'de',
                'Grƒçija': 'gr', 'Irska': 'ie', 'Italija': 'it', 'Latvija': 'lv', 'Litva': 'lt',
                'Luksemburg': 'lu', 'Malta': 'mt', 'Monako': 'mc', 'Nizozemska': 'nl', 'Portugalska': 'pt',
                'San Marino': 'sm', 'Slova≈°ka': 'sk', 'Slovenija': 'si', '≈†panija': 'es', 'Vatikan': 'va'
            };
            const code = map[countryName] || 'eu';
            return `<img src="https://flagcdn.com/${code}.svg" alt="${countryName}" class="w-full h-full object-cover">`;
        }

        // --- RENDER DR≈ΩAV ---
        function renderCountries() {
            const grid = document.getElementById('countries-grid');
            let html = '';

            UNIQUE_COUNTRIES.forEach(country => {
                const countryCoins = regularCoins.filter(c => c.country === country);
                const collectedCount = countryCoins.filter(c => !!collectedCoins[c.id]).length;
                const totalCount = countryCoins.length;
                
                const isCovered = collectedCount > 0;
                const isCompleted = collectedCount === totalCount;
                const needsReplacement = countryCoins.some(c => collectedCoins[c.id] === 'poor');
                const firstCoinImg = countryCoins[0].imageUrl;
                
                let borderClass = 'border-slate-200 bg-white';
                let checkBadge = '';
                let statusTextClass = 'text-slate-400';
                
                if (isCompleted) {
                    borderClass = 'border-green-400 bg-green-50/40 shadow-green-100';
                    checkBadge = `<div class="absolute -top-2 -right-2 bg-green-500 text-white rounded-full p-1 shadow-md z-20"><i data-lucide="check" class="w-3 h-3"></i></div>`;
                    statusTextClass = 'text-green-600';
                } else if (isCovered) {
                    borderClass = 'border-blue-400 bg-blue-50/30 shadow-blue-50';
                    checkBadge = `<div class="absolute -top-2 -right-2 bg-blue-500 text-white rounded-full p-1 shadow-md z-20"><i data-lucide="check" class="w-3 h-3"></i></div>`;
                    statusTextClass = 'text-blue-600';
                }

                let replacementBadge = '';
                if (needsReplacement) {
                    replacementBadge = `<div class="absolute -top-2 -left-2 bg-orange-500 text-white rounded-full p-1 shadow-md z-20" title="I≈°ƒçe se lep≈°i kovanec"><i data-lucide="refresh-cw" class="w-3 h-3"></i></div>`;
                }

                html += `
                <div onclick="openCountryModal('${country}')" class="card-hover cursor-pointer border-2 rounded-2xl p-3 flex flex-col items-center text-center relative ${borderClass} shadow-sm">
                    ${checkBadge}
                    ${replacementBadge}
                    <div class="relative w-14 h-14 sm:w-16 sm:h-16 mb-2">
                        <div class="w-full h-full rounded-full overflow-hidden border-[3px] border-[#cbd5e1] shadow-[inset_0_0_8px_rgba(0,0,0,0.3)] relative bg-[#cbd5e1]">
                             <img src="${firstCoinImg}" alt="${country}" class="w-full h-full object-cover mix-blend-multiply opacity-90" loading="lazy" />
                             <div class="absolute inset-0 bg-gradient-to-tr from-white/10 to-transparent pointer-events-none rounded-full"></div>
                        </div>
                        <div class="absolute -bottom-1 -right-1 w-6 h-4 border border-white rounded shadow-sm overflow-hidden z-10">
                            ${getFlagImg(country)}
                        </div>
                    </div>
                    <h3 class="text-xs sm:text-sm font-bold text-slate-800 leading-tight mb-1 truncate w-full px-1">${country}</h3>
                    <div class="text-[9px] sm:text-[10px] font-black ${statusTextClass} bg-white/80 px-2 py-0.5 rounded-lg border border-slate-100 w-full truncate">
                        ${collectedCount} / ${totalCount} serij
                    </div>
                </div>`;
            });
            grid.innerHTML = html;
        }

        // --- RENDER MRE≈ΩE SLOVENSKIH KOVANCEV ---
        function renderSloGrid() {
            const container = document.getElementById('slo-grid');
            const sloCoins = COINS.filter(c => c.type === 'Commemorative');
            
            // Posodobimo ikono in besedilo gumba glede na stanje
            const compactIcon = document.getElementById('compact-icon');
            const compactText = document.getElementById('compact-text');
            if (compactIcon && compactText) {
                compactIcon.setAttribute('data-lucide', compactMode ? 'list' : 'layout-grid');
                compactText.innerText = compactMode ? 'Podrobno' : 'Zgosti';
            }

            // Dinamiƒçna mre≈æa glede na to, ali je pogled kompakten
            const gridCols = compactMode 
                ? "grid-cols-3 sm:grid-cols-5 md:grid-cols-7 gap-3" 
                : "grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 sm:gap-4";

            let html = `<div class="grid ${gridCols}">`;
            
            sloCoins.forEach((coin) => {
                const isCollected = !!collectedCoins[coin.id];
                const state = collectedCoins[coin.id]; 
                
                let cardBorder = 'border-slate-200 bg-white hover:border-slate-300';
                let checkBadge = '';
                let replacementBadge = '';
                
                if (isCollected) {
                    cardBorder = 'border-blue-400 bg-blue-50/30 shadow-blue-50';
                    checkBadge = `<div class="absolute -top-2 -right-2 bg-blue-500 text-white rounded-full p-1 shadow-md z-20"><i data-lucide="check" class="${compactMode ? 'w-2.5 h-2.5' : 'w-3 h-3'}"></i></div>`;
                    if (state === 'poor') {
                        replacementBadge = `<div class="absolute -top-2 -left-2 bg-orange-500 text-white rounded-full p-1 shadow-md z-20" title="I≈°ƒçe se lep≈°i kovanec"><i data-lucide="refresh-cw" class="${compactMode ? 'w-2.5 h-2.5' : 'w-3 h-3'}"></i></div>`;
                    }
                }

                if (compactMode) {
                    // --- KOMPAKTNA KARTICA ---
                    let compactConditionBadge = '';
                    if (isCollected) {
                        const icon = state === 'poor' ? 'refresh-cw' : 'sparkles';
                        const colorClass = state === 'poor' ? 'text-orange-600 bg-orange-100 border-orange-200' : 'text-yellow-600 bg-yellow-100 border-yellow-200';
                        compactConditionBadge = `
                            <div onclick="toggleCondition('${coin.id}', event)" class="absolute -bottom-2.5 left-1/2 transform -translate-x-1/2 ${colorClass} border rounded-full p-1 shadow-sm z-20 cursor-pointer hover:scale-110 transition-transform" title="${state === 'poor' ? 'Zamenjaj' : 'Odliƒçno'}">
                                <i data-lucide="${icon}" class="w-3 h-3"></i>
                            </div>`;
                    }

                    html += `
                    <div onclick="toggleCoin('${coin.id}')" class="h-full card-hover cursor-pointer border-2 rounded-[1rem] p-1.5 pt-4 flex flex-col items-center text-center relative ${cardBorder} shadow-sm transition-all duration-300">
                        ${checkBadge}
                        ${replacementBadge}
                        <div class="absolute top-1 left-1/2 transform -translate-x-1/2 text-[8px] font-black text-slate-400 bg-slate-100/80 backdrop-blur-sm px-1.5 rounded-sm">${coin.year}</div>
                        ${compactConditionBadge}
                        
                        <div class="w-full aspect-square relative group mt-1" onclick="openZoom('${coin.imageUrl}', '${coin.title}'); event.stopPropagation();">
                            <div class="w-full h-full rounded-full overflow-hidden border-[2px] border-[#cbd5e1] shadow-inner relative bg-[#cbd5e1] transition-transform duration-300 group-hover:scale-105">
                                 <img src="${coin.imageUrl}" alt="${coin.title}" class="w-full h-full object-cover mix-blend-multiply opacity-90" loading="lazy" />
                                 <div class="absolute inset-0 bg-gradient-to-tr from-white/10 to-transparent pointer-events-none rounded-full"></div>
                            </div>
                        </div>
                    </div>`;
                } else {
                    // --- PODROBNA KARTICA ---
                    let conditionBadge = '';
                    if (isCollected) {
                        const badgeClass = state === 'poor'
                             ? 'bg-orange-100 text-orange-700 border-orange-200 hover:bg-orange-200'
                             : 'bg-yellow-100 text-yellow-700 border-yellow-200 hover:bg-yellow-200';
                        const icon = state === 'poor' ? 'refresh-cw' : 'sparkles';
                        const text = state === 'poor' ? 'Zamenjaj' : 'Odliƒçno';
                        conditionBadge = `
                            <div onclick="toggleCondition('${coin.id}', event)" class="${badgeClass} border px-2 py-0.5 mt-2 rounded-lg text-[9px] font-bold flex items-center justify-center gap-1 shadow-sm transition-transform active:scale-90 z-20 cursor-pointer w-full max-w-[100px]">
                                <i data-lucide="${icon}" class="w-3 h-3"></i> ${text}
                            </div>`;
                    } else {
                        conditionBadge = `<div class="h-6 mt-2"></div>`;
                    }

                    html += `
                    <div onclick="toggleCoin('${coin.id}')" class="h-full card-hover cursor-pointer border-2 rounded-2xl p-3 flex flex-col items-center text-center relative ${cardBorder} shadow-sm transition-all duration-300">
                        ${checkBadge}
                        ${replacementBadge}
                        <div class="absolute top-2 left-2 text-[9px] font-black text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded shadow-sm">${coin.year}</div>
                        
                        <div class="w-14 h-14 sm:w-16 sm:h-16 mb-2 mt-2 relative group flex-shrink-0" onclick="openZoom('${coin.imageUrl}', '${coin.title}'); event.stopPropagation();">
                            <div class="w-full h-full rounded-full overflow-hidden border-[3px] border-[#cbd5e1] shadow-inner relative bg-[#cbd5e1] transition-transform duration-300 group-hover:scale-105">
                                 <img src="${coin.imageUrl}" alt="${coin.title}" class="w-full h-full object-cover mix-blend-multiply opacity-90" loading="lazy" />
                                 <div class="absolute inset-0 bg-gradient-to-tr from-white/10 to-transparent pointer-events-none rounded-full"></div>
                                 <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200 rounded-full">
                                     <i data-lucide="zoom-in" class="w-4 h-4 text-white"></i>
                                 </div>
                            </div>
                        </div>
                        
                        <div class="flex-1 flex flex-col items-center justify-end w-full">
                            <h3 class="text-xs sm:text-[13px] font-bold text-slate-800 leading-tight mb-0 line-clamp-3">${coin.title}</h3>
                            ${conditionBadge}
                        </div>
                    </div>`;
                }
            });

            html += `</div>`;
            container.innerHTML = html;
        }

        // --- MODALNO OKNO DR≈ΩAV ---
        function openCountryModal(countryName) {
            const coinsOfCountry = regularCoins.filter(c => c.country === countryName);
            document.getElementById('modal-title').innerText = countryName;
            document.getElementById('modal-badge').innerText = 'Evrski redni kovanci';
            
            let listHtml = '<div class="space-y-3 mt-4 pb-2">';
            coinsOfCountry.forEach(coin => {
                const isCol = !!collectedCoins[coin.id];
                const state = collectedCoins[coin.id];
                let itemClass = 'bg-slate-50 border-slate-200 hover:border-blue-300';
                let checkIcon = `<i data-lucide="circle" class="text-slate-300 w-6 h-6"></i>`;
                let replacementBadge = '';
                let conditionBadge = '';
                
                if (isCol) {
                    itemClass = 'bg-green-50 border-green-400 shadow-sm';
                    if (state === 'poor') {
                        replacementBadge = `<div class="absolute -top-2 -left-2 bg-orange-500 text-white rounded-full p-1 shadow-md z-20"><i data-lucide="refresh-cw" class="w-3 h-3"></i></div>`;
                    }
                    checkIcon = `<i data-lucide="check-circle" class="text-green-600 w-6 h-6 fill-green-200 drop-shadow-sm"></i>`;
                    
                    const badgeClass = state === 'poor'
                         ? 'bg-orange-100 text-orange-700 border-orange-200 hover:bg-orange-200'
                         : 'bg-yellow-100 text-yellow-700 border-yellow-200 hover:bg-yellow-200';
                    const icon = state === 'poor' ? 'refresh-cw' : 'sparkles';
                    const text = state === 'poor' ? 'Zamenjaj' : 'Odliƒçno';
                    conditionBadge = `
                        <div onclick="toggleCondition('${coin.id}', event);" class="${badgeClass} border px-2 py-1 rounded-lg text-[9px] font-bold flex items-center gap-1 shadow-sm transition-transform active:scale-90 z-20 mt-1.5 w-max cursor-pointer">
                            <i data-lucide="${icon}" class="w-3 h-3"></i> ${text}
                        </div>`;
                }

                listHtml += `
                <div onclick="toggleCoin('${coin.id}'); event.stopPropagation();" class="cursor-pointer border-2 rounded-2xl p-3 flex items-center gap-3 transition-all active:scale-95 relative ${itemClass}">
                    ${replacementBadge}
                    <div class="w-12 h-12 flex-shrink-0 relative group" onclick="openZoom('${coin.imageUrl}', '${coin.title}'); event.stopPropagation();">
                        <div class="w-full h-full rounded-full overflow-hidden border-[2px] border-[#cbd5e1] shadow-inner relative bg-[#cbd5e1] transition-transform group-hover:scale-105">
                            <img src="${coin.imageUrl}" alt="Serija" class="w-full h-full object-cover mix-blend-multiply opacity-90" />
                            <div class="absolute inset-0 bg-gradient-to-tr from-white/10 to-transparent pointer-events-none rounded-full"></div>
                            <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200 rounded-full">
                                <i data-lucide="zoom-in" class="w-4 h-4 text-white"></i>
                            </div>
                        </div>
                    </div>
                    <div class="text-left flex-1 min-w-0">
                        <div class="text-xs font-bold text-slate-800 mb-0.5 truncate">${coin.year}</div>
                        <div class="text-[10px] text-slate-500 leading-tight line-clamp-2">${coin.description}</div>
                        ${conditionBadge}
                    </div>
                    <div class="flex-shrink-0">
                        ${checkIcon}
                    </div>
                </div>`;
            });
            listHtml += '</div>';
            document.getElementById('modal-dynamic-content').innerHTML = listHtml;

            const modal = document.getElementById('coin-modal');
            const content = document.getElementById('coin-modal-content');
            modal.classList.remove('hidden');
            lucide.createIcons();
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            });
        }

        function closeModal() {
            const modal = document.getElementById('coin-modal');
            const content = document.getElementById('coin-modal-content');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        // --- OBLAK MODAL IN FUNKCIJE ---
        function openSyncModal() {
            document.getElementById('sync-input').value = currentSyncCode;
            document.getElementById('sync-error').innerText = "";
            
            const modal = document.getElementById('sync-modal');
            const content = document.getElementById('sync-modal-content');
            modal.classList.remove('hidden');
            lucide.createIcons();
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            });
        }

        function closeSyncModal() {
            const modal = document.getElementById('sync-modal');
            const content = document.getElementById('sync-modal-content');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        function generateRandomCode() {
            const randomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
            document.getElementById('sync-input').value = randomCode;
        }

        function loadFromCode() {
            const input = document.getElementById('sync-input').value.trim().toUpperCase();
            if (input.length < 3) {
                document.getElementById('sync-error').innerText = "Koda mora imeti vsaj 3 znake!";
                return;
            }
            if (!/^[A-Z0-9]+$/.test(input)) {
                document.getElementById('sync-error').innerText = "Dovoljene so samo ƒçrke in ≈°tevilke!";
                return;
            }
            document.getElementById('sync-error').innerText = "";
            
            // Nastavi novo kodo
            currentSyncCode = input;
            localStorage.setItem('euro_sync_code', currentSyncCode);
            
            // Prisluhni novi zbirki - se nalo≈æi avtomatsko preko onSnapshot
            listenToCollection(currentSyncCode);
            
            closeSyncModal();
        }

        // --- GLAVNI RENDER ---
        function renderApp() {
            let regCollectedCountries = 0;
            UNIQUE_COUNTRIES.forEach(country => {
                 if (regularCoins.filter(c => c.country === country).some(c => !!collectedCoins[c.id])) {
                    regCollectedCountries++;
                }
            });
            const regPercent = Math.round((regCollectedCountries / 25) * 100) || 0;

            const sloCoins = COINS.filter(c => c.type === 'Commemorative');
            const slTotal = sloCoins.length;
            const slCollected = sloCoins.filter(c => !!collectedCoins[c.id]).length;
            const slPercent = Math.round((slCollected / slTotal) * 100) || 0;

            document.getElementById('reg-collected').innerText = regCollectedCountries;
            document.getElementById('reg-bar').style.width = `${regPercent}%`;
            
            document.getElementById('sl-collected').innerText = slCollected;
            document.getElementById('sl-total').innerText = slTotal;
            
            const totalValue = (Object.keys(collectedCoins).length) * 2;
            document.getElementById('total-value').innerText = `‚Ç¨${totalValue}.00`;

            document.getElementById('sl-bar-white').style.width = `${slPercent / 3}%`;
            document.getElementById('sl-bar-blue').style.width = `${slPercent / 3}%`;
            document.getElementById('sl-bar-red').style.width = `${slPercent / 3}%`;

            renderCountries();
            renderSloGrid();
            lucide.createIcons();
        }

        // --- ZAGON ---
        window.onload = () => {
            renderApp();
            switchView('countries');
        };
    </script>

    <!-- Univerzalno Modalno Okno -->
    <div id="coin-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300" onclick="if(event.target === this) closeModal()">
        <div class="bg-white rounded-[2rem] p-5 max-w-sm w-full mx-4 relative shadow-2xl transform scale-95 transition-transform duration-300 max-h-[85vh] overflow-y-auto no-scrollbar" id="coin-modal-content">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-800 bg-slate-100 hover:bg-slate-200 rounded-full p-2 transition-colors z-10">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <div class="text-center mt-2">
                <div id="modal-badge" class="inline-block px-3 py-1 bg-slate-100 text-slate-600 rounded-full text-[10px] font-black tracking-widest mb-2 uppercase"></div>
                <h2 id="modal-title" class="text-2xl font-black text-slate-800 leading-tight mb-4"></h2>
                <div id="modal-dynamic-content" class="text-left pb-2"></div>
            </div>
        </div>
    </div>

    <!-- Modalno Okno za Poveƒçavo Slike (Zoom Viewer) -->
    <div id="zoom-modal" class="fixed inset-0 bg-black/90 backdrop-blur-xl flex flex-col items-center justify-center z-[70] hidden opacity-0 transition-opacity duration-300 cursor-zoom-out" onclick="closeZoom()">
        <div class="absolute top-6 right-6 text-white/70 bg-white/10 rounded-full p-2.5 z-10 pointer-events-none">
            <i data-lucide="x" class="w-6 h-6"></i>
        </div>
        <div class="flex flex-col items-center justify-center p-6 w-full max-w-md mx-auto pointer-events-none">
            <div class="relative w-full aspect-square rounded-full overflow-hidden border-[4px] border-[#e2e8f0] shadow-[0_0_100px_rgba(255,255,255,0.2)] bg-[#cbd5e1] transition-transform duration-500 transform scale-95" id="zoom-image-container">
                <img id="zoom-image" src="" alt="Poveƒçan kovanec" class="w-full h-full object-cover mix-blend-multiply" />
                <div class="absolute inset-0 bg-gradient-to-tr from-white/30 to-transparent pointer-events-none rounded-full"></div>
            </div>
            <h3 id="zoom-title" class="text-white text-2xl font-black mt-8 text-center px-4 tracking-wide drop-shadow-md"></h3>
            <p class="text-white/70 text-xs mt-4 font-bold uppercase tracking-widest bg-white/10 px-5 py-2.5 rounded-full backdrop-blur-sm flex items-center gap-2">
                <i data-lucide="mouse-pointer-click" class="w-4 h-4"></i> Tapni kjerkoli za izhod
            </p>
        </div>
    </div>

    <!-- Modalno Okno za Oblak / Firebase kodo -->
    <div id="sync-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-[60] hidden opacity-0 transition-opacity duration-300" onclick="if(event.target === this) closeSyncModal()">
        <div class="bg-white rounded-[2rem] p-6 max-w-sm w-full mx-4 relative shadow-2xl transform scale-95 transition-transform duration-300" id="sync-modal-content">
            <button onclick="closeSyncModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-800 bg-slate-100 hover:bg-slate-200 rounded-full p-2 transition-colors z-10">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>

            <div class="text-center mt-2">
                <div class="mx-auto w-16 h-16 bg-blue-100 text-blue-500 rounded-full flex items-center justify-center mb-4 shadow-inner">
                    <i data-lucide="cloud" class="w-8 h-8"></i>
                </div>
                <h2 class="text-xl font-black text-slate-800 mb-2">Oblak in Sinhronizacija</h2>
                <p class="text-xs text-slate-500 mb-6 px-2">Vnesite poljubno uporabni≈°ko ime (kodo) in se pove≈æite. S to kodo lahko do zbirke dostopate na vseh svojih napravah.</p>

                <div class="relative w-full mb-1">
                    <input type="text" id="sync-input" class="w-full bg-slate-50 border-2 border-slate-200 focus:border-blue-400 focus:ring-0 rounded-xl pl-4 pr-12 py-3 text-center font-mono text-xl tracking-widest font-bold uppercase outline-none transition-colors" placeholder="VNESI KODO" maxlength="15">
                    <button onclick="generateRandomCode()" class="absolute right-2 top-1/2 transform -translate-y-1/2 p-2 text-slate-400 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition-colors" title="Zgeneriraj nakljuƒçno kodo">
                        <i data-lucide="dices" class="w-5 h-5"></i>
                    </button>
                </div>
                <div id="sync-error" class="text-red-500 text-[10px] font-bold uppercase tracking-wide h-4 mb-3"></div>

                <button onclick="loadFromCode()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2">
                    <i data-lucide="cloud-lightning" class="w-5 h-5"></i> Pove≈æi se
                </button>

                <!-- Skrita nevarna cona za izbris raƒçuna -->
                <div class="mt-6 pt-4 border-t border-red-100">
                    <button onclick="resetCollection(); closeSyncModal();" class="w-full bg-red-50 hover:bg-red-100 text-red-600 font-bold py-3 rounded-xl transition-colors flex items-center justify-center gap-2 text-sm">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> Izbri≈°i to zbirko
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
