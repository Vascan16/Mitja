<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepFocus Medieval</title>
    
    <!-- 1. TAILWIND CSS (Stili) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. NOISE TEXTURE (Za ozadje) -->
    <style>
        body { font-family: 'Times New Roman', serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Custom date input styling to look like an icon/text */
        .date-picker-trigger::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-[#f3e9d2] text-[#2c1810]">
    <div id="root"></div>

    <!-- 3. LOGIKA APLIKACIJE (React + Firebase) -->
    <script type="module">
        // Uvoz knjižnic neposredno iz spleta (ESM modules)
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Check, Minus, BarChart2, User, Scroll, Calendar, Shield, Crown, 
            Sword, Feather, Grid, HelpCircle, Hammer, Anchor, Flame, Book, 
            Star, Sun, Cloud, Loader, AlertTriangle, Link, Save, ChevronDown, RefreshCw 
        } from 'https://esm.sh/lucide-react@0.292.0';

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // =================================================================
        // --- 1. KONFIGURACIJA (TUKAJ VPIŠI SVOJE PODATKE ZA GITHUB) ---
        // =================================================================
        
        const manualConfig = {
          apiKey: "AIzaSyC5uqhPfv_q1dx9xMk4VnWu6wq7AOKmjB8",
          authDomain: "delo-ae21b.firebaseapp.com",
          projectId: "delo-ae21b",
          storageBucket: "delo-ae21b.firebasestorage.app",
          messagingSenderId: "721173225350",
          appId: "1:721173225350:web:83926980686c6f4ec11607",
          measurementId: "G-4STZTWDQ1X"
        };

        // --- Logika inicializacije (Ne tikaj) ---
        let firebaseConfig = null;
        let isAutoConfig = false;

        if (typeof __firebase_config !== 'undefined') {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
                isAutoConfig = true;
            } catch (e) { console.error("Napaka pri branju auto-configa"); }
        } 
        
        if (!firebaseConfig) {
            firebaseConfig = manualConfig;
        }

        // Inicializacija Firebase
        let app, auth, db;
        let firebaseInitialized = false;
        let configError = false;

        if (firebaseConfig.apiKey === "TUKAJ_VPIŠI_API_KEY" && !isAutoConfig) {
            configError = true;
        } else {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                firebaseInitialized = true;
            } catch (e) {
                console.warn("Firebase inicializacija ni uspela:", e);
            }
        }

        const envAppId = typeof __app_id !== 'undefined' ? __app_id : 'deepfocus-medieval';
        const envInitialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // =================================================================
        // --- 2. KODA APLIKACIJE ---
        // =================================================================

        const CILJ_DEL = 3;
        const XP_PER_BLOCK = 100;

        const RANK_SYSTEM = [
            { minLevel: 1, title: "Služabnik", saint: "Sv. Jožef Delavec", saintDesc: "Zavetnik tihega dela.", icon: Hammer, theme: { paper: "#f3e9d2", paperDark: "#eaddcf", ink: "#2c1810", inkLight: "rgba(44, 24, 16, 0.6)", accent: "#854d0e", accentDim: "rgba(133, 77, 14, 0.1)" } },
            { minLevel: 5, title: "Oproda", saint: "Sv. Krištof", saintDesc: "Zavetnik popotnikov.", icon: Anchor, theme: { paper: "#e5e7eb", paperDark: "#d1d5db", ink: "#111827", inkLight: "rgba(17, 24, 39, 0.6)", accent: "#374151", accentDim: "rgba(55, 65, 81, 0.1)" } },
            { minLevel: 10, title: "Vitez", saint: "Sv. Jurij", saintDesc: "Premagovalec zmaja.", icon: Sword, theme: { paper: "#fff1f2", paperDark: "#ffe4e6", ink: "#450a0a", inkLight: "rgba(69, 10, 10, 0.6)", accent: "#be123c", accentDim: "rgba(190, 18, 60, 0.1)" } },
            { minLevel: 15, title: "Baron", saint: "Sv. Benedikt", saintDesc: "Oče 'Ora et Labora'.", icon: Shield, theme: { paper: "#eff6ff", paperDark: "#dbeafe", ink: "#172554", inkLight: "rgba(23, 37, 84, 0.6)", accent: "#2563eb", accentDim: "rgba(37, 99, 235, 0.1)" } },
            { minLevel: 20, title: "Vojvoda", saint: "Sv. Hieronim", saintDesc: "Velik učenjak.", icon: Book, theme: { paper: "#faf5ff", paperDark: "#f3e8ff", ink: "#3b0764", inkLight: "rgba(59, 7, 100, 0.6)", accent: "#7e22ce", accentDim: "rgba(126, 34, 206, 0.1)" } },
            { minLevel: 25, title: "Kralj", saint: "Sv. Tomaž Akvinski", saintDesc: "Angelski učitelj.", icon: Crown, theme: { paper: "#fffbeb", paperDark: "#fef3c7", ink: "#000000", inkLight: "rgba(0, 0, 0, 0.6)", accent: "#d97706", accentDim: "rgba(217, 119, 6, 0.1)" } }
        ];

        const getCurrentRankInfo = (level) => {
            const rank = [...RANK_SYSTEM].reverse().find(r => level >= r.minLevel);
            return rank || RANK_SYSTEM[0];
        };

        const getTodayString = () => new Date().toISOString().split('T')[0];
        const formatDateShort = (dateStr) => {
            const d = new Date(dateStr);
            return d.toLocaleDateString('sl-SI', { day: 'numeric', month: 'short' });
        };
        const getDayName = (dateStr) => {
            const d = new Date(dateStr);
            return d.toLocaleDateString('sl-SI', { weekday: 'short' }).toUpperCase();
        };
        
        // Generiranje traku glede na sidrni datum
        const generateDateRange = (daysBack, daysForward, referenceDateStr) => {
            const dates = [];
            const refDate = referenceDateStr ? new Date(referenceDateStr) : new Date();
            
            for (let i = -daysBack; i <= daysForward; i++) {
                const d = new Date(refDate);
                d.setDate(refDate.getDate() + i);
                dates.push({
                    full: d.toISOString().split('T')[0],
                    day: d.getDate(),
                    weekday: d.toLocaleDateString('sl-SI', { weekday: 'short' }).toUpperCase(),
                    isToday: i === 0 
                });
            }
            return dates;
        };

        function DeepFocusMedieval() {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('cockpit');
            const [selectedDate, setSelectedDate] = useState(getTodayString());
            const [history, setHistory] = useState({}); 
            
            const [syncId, setSyncId] = useState(localStorage.getItem('deepfocus_sync_id') || '');
            const [tempSyncId, setTempSyncId] = useState('');

            // Auth Logic
            useEffect(() => {
                if (!firebaseInitialized) { setAuthLoading(false); return; }
                const initAuth = async () => {
                    try {
                        if (envInitialToken) await signInWithCustomToken(auth, envInitialToken);
                        else await signInAnonymously(auth);
                    } catch (error) { console.error("Auth error:", error); } 
                    finally { setAuthLoading(false); }
                };
                initAuth();
                return onAuthStateChanged(auth, setUser);
            }, []);

            // Data Sync Logic
            useEffect(() => {
                if (!user || !db) return;
                const userIdToUse = syncId && syncId.length > 3 ? `vitez_${syncId}` : user.uid;
                
                let q;
                if (isAutoConfig) q = collection(db, 'artifacts', envAppId, 'users', userIdToUse, 'daily_logs');
                else q = collection(db, 'users', userIdToUse, 'daily_logs');

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const newHistory = {};
                    snapshot.forEach((doc) => {
                        newHistory[doc.id] = doc.data().count;
                    });
                    setHistory(newHistory);
                }, (err) => { if (err.code !== 'permission-denied') console.error("Sync error:", err); });
                return () => unsubscribe();
            }, [user, syncId]);

            // Save Sync ID
            const saveSyncId = () => {
                if(tempSyncId.trim().length > 0) {
                    setSyncId(tempSyncId.trim());
                    localStorage.setItem('deepfocus_sync_id', tempSyncId.trim());
                    alert("Povezava uspešna! Podatki se bodo naložili.");
                }
            };

            const clearSyncId = () => {
                setSyncId('');
                setTempSyncId('');
                localStorage.removeItem('deepfocus_sync_id');
            }

            // NOVO: Generiranje naključne kode
            const generateRandomCode = () => {
                const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
                let result = "";
                for (let i = 0; i < 6; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                const formatted = result.slice(0,3) + "-" + result.slice(3);
                setTempSyncId(formatted);
            };

            const blocksCompleted = history[selectedDate] || 0;
            const isVictory = blocksCompleted >= CILJ_DEL;
            
            // Prikaz: 3 dni nazaj, 2 dni naprej od izbranega datuma.
            const dateStrip = generateDateRange(3, 2, selectedDate);
            
            const scrollRef = useRef(null);

            useEffect(() => { 
                if (scrollRef.current) scrollRef.current.scrollLeft = 0; 
            }, [selectedDate]);

            const totalBlocks = Object.values(history).reduce((a, b) => a + b, 0);
            const totalXP = totalBlocks * XP_PER_BLOCK;
            const currentLevel = Math.floor(Math.sqrt(totalXP / 100)) + 1;
            const currentRank = getCurrentRankInfo(currentLevel);
            const theme = currentRank.theme;

            const xpForCurrentLevel = Math.pow(currentLevel - 1, 2) * 100;
            const xpForNextLevel = Math.pow(currentLevel, 2) * 100;
            const xpProgressInLevel = totalXP - xpForCurrentLevel;
            const xpNeededForNextLevel = xpForNextLevel - xpForCurrentLevel;
            const progressPercent = Math.min((xpProgressInLevel / xpNeededForNextLevel) * 100, 100);

            const updateBlocks = async (change) => {
                const currentVal = history[selectedDate] || 0;
                const newVal = Math.max(0, currentVal + change);
                setHistory(prev => ({...prev, [selectedDate]: newVal}));

                if (user && db) {
                    const userIdToUse = syncId && syncId.length > 3 ? `vitez_${syncId}` : user.uid;
                    try {
                        let docRef;
                        if (isAutoConfig) docRef = doc(db, 'artifacts', envAppId, 'users', userIdToUse, 'daily_logs', selectedDate);
                        else docRef = doc(db, 'users', userIdToUse, 'daily_logs', selectedDate);
                        await setDoc(docRef, { count: newVal }, { merge: true });
                    } catch (err) { console.error("Save error:", err); }
                }
                if (change > 0 && navigator.vibrate) navigator.vibrate(50);
            };

            const resetDay = async () => {
                setHistory(prev => ({...prev, [selectedDate]: 0}));
                if (user && db) {
                    const userIdToUse = syncId && syncId.length > 3 ? `vitez_${syncId}` : user.uid;
                    let docRef;
                    if (isAutoConfig) docRef = doc(db, 'artifacts', envAppId, 'users', userIdToUse, 'daily_logs', selectedDate);
                    else docRef = doc(db, 'users', userIdToUse, 'daily_logs', selectedDate);
                    await setDoc(docRef, { count: 0 }, { merge: true });
                }
            };

            const appStyle = {
                '--bg-paper': theme.paper, '--bg-paper-dark': theme.paperDark,
                '--text-ink': theme.ink, '--text-ink-light': theme.inkLight,
                '--color-accent': theme.accent, '--color-accent-dim': theme.accentDim,
            };

            if (authLoading) return React.createElement('div', { className: "h-screen w-full flex items-center justify-center" }, React.createElement(Loader, { className: "animate-spin" }));

            return (
                React.createElement('div', { 
                    className: "h-screen w-full flex flex-col font-serif overflow-hidden relative transition-colors duration-1000",
                    style: { backgroundColor: 'var(--bg-paper)', color: 'var(--text-ink)', ...appStyle }
                },
                    // Background & Warnings
                    React.createElement('div', { className: "absolute inset-0 opacity-10 pointer-events-none mix-blend-multiply", style: { backgroundImage: `url("data:image/svg+xml,%3Csvg width='200' height='200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.5'/%3E%3C/svg%3E")` } }),
                    
                    configError && React.createElement('div', { className: "absolute top-0 left-0 w-full bg-red-600 text-white text-xs p-2 text-center z-50 font-sans" }, 
                        "NAPAKA: V index.html vpiši svoje Firebase podatke! (Glej vrstico 35)"
                    ),

                    // Main Content
                    React.createElement('div', { className: "flex-1 flex flex-col z-10 relative overflow-hidden" },
                        // Header
                        React.createElement('div', { 
                            className: "h-32 flex-none border-b-2 pt-2 pb-2 z-20 flex flex-col justify-between transition-colors duration-500 shadow-sm",
                            style: { backgroundColor: 'var(--bg-paper-dark)', borderColor: 'var(--color-accent-dim)' }
                        },
                            // Top Bar: Dropdown Menu & Level
                            React.createElement('div', { className: "flex items-center justify-between px-6 py-2" },
                                
                                // Dropdown za ročno izbiro
                                React.createElement('div', { 
                                    className: "relative group flex items-center gap-2 cursor-pointer px-3 py-1.5 rounded border transition-all hover:bg-white/10 active:scale-95",
                                    style: { borderColor: 'var(--color-accent-dim)' }
                                },
                                    React.createElement(Calendar, { size: 16, style: { color: 'var(--color-accent)' } }),
                                    React.createElement('span', { className: "text-xs font-bold uppercase tracking-widest", style: { color: 'var(--text-ink)' } }, "Koledar"),
                                    React.createElement(ChevronDown, { size: 14, style: { color: 'var(--text-ink-light)' } }),
                                    
                                    // Hidden Date Input trigger
                                    React.createElement('input', {
                                        type: "date",
                                        className: "absolute inset-0 opacity-0 w-full h-full cursor-pointer date-picker-trigger",
                                        onChange: (e) => {
                                            if(e.target.value) setSelectedDate(e.target.value);
                                        },
                                        max: getTodayString()
                                    })
                                ),
                                
                                // Mini XP Bar
                                React.createElement('div', { className: "flex flex-col items-end w-32" },
                                    React.createElement('div', { className: "text-xs font-bold flex justify-between w-full mb-1", style: { color: 'var(--text-ink-light)' } },
                                        React.createElement('span', { className: "text-[10px]" }, `Lvl ${currentLevel}`),
                                        React.createElement('span', { className: "opacity-50 text-[10px]" }, `${Math.floor(progressPercent)}%`)
                                    ),
                                    React.createElement('div', { className: "w-full h-1 rounded-full overflow-hidden", style: { backgroundColor: 'var(--color-accent-dim)' } },
                                        React.createElement('div', { className: "h-full transition-all duration-500", style: { width: `${progressPercent}%`, backgroundColor: 'var(--color-accent)' } })
                                    )
                                )
                            ),
                            
                            // Trak datumov
                            React.createElement('div', { ref: scrollRef, className: "flex gap-3 overflow-x-auto px-6 pb-2 hide-scrollbar scroll-smooth items-center justify-center h-full", style: { scrollbarWidth: 'none', msOverflowStyle: 'none' } },
                                dateStrip.map((d, i) => {
                                    const isSelected = selectedDate === d.full;
                                    const blocks = history[d.full] || 0;
                                    const goalMet = blocks >= CILJ_DEL;
                                    
                                    return React.createElement('button', {
                                        key: i, onClick: () => setSelectedDate(d.full),
                                        className: `flex-none rounded-lg border-2 transition-all duration-300 flex flex-col items-center justify-center relative overflow-hidden group ${isSelected ? 'w-14 h-16 shadow-lg transform -translate-y-1 z-10' : 'w-12 h-14 opacity-70 hover:opacity-100'}`,
                                        style: {
                                            backgroundColor: isSelected ? 'var(--text-ink)' : 'var(--bg-paper)',
                                            borderColor: isSelected ? 'var(--text-ink)' : 'var(--color-accent-dim)',
                                            color: isSelected ? 'var(--bg-paper)' : 'var(--text-ink-light)',
                                        }
                                    },
                                        // Highlight overlay for selected
                                        isSelected && React.createElement('div', { className: "absolute inset-0 opacity-10 bg-white" }),
                                        
                                        React.createElement('span', { className: "text-[9px] uppercase font-bold tracking-wider mb-0.5" }, d.weekday),
                                        React.createElement('span', { className: `leading-none font-serif ${isSelected ? 'text-xl' : 'text-lg'}` }, d.day),
                                        
                                        // Pika za aktivnost
                                        blocks > 0 && !isSelected && React.createElement('div', { 
                                            className: "mt-1 w-1.5 h-1.5 rounded-full", 
                                            style: { backgroundColor: goalMet ? 'var(--color-accent)' : 'var(--text-ink-light)' } 
                                        }),
                                        
                                        // Zlata črta spodaj za izbranega
                                        isSelected && React.createElement('div', { 
                                            className: "absolute bottom-0 left-0 w-full h-1", 
                                            style: { backgroundColor: 'var(--color-accent)' } 
                                        })
                                    );
                                })
                            )
                        ),

                        // Tab Content
                        React.createElement('div', { className: "flex-1 overflow-y-auto relative p-6" },
                            activeTab === 'cockpit' && React.createElement(Delavnica, { blocks: blocksCompleted, onAdd: () => updateBlocks(1), onRemove: () => updateBlocks(-1), isVictory }),
                            activeTab === 'vault' && React.createElement(Kronika, { history }),
                            activeTab === 'barracks' && React.createElement(Vitez, { 
                                history, resetDay, selectedDate, currentLevel, totalXP, 
                                xpNeededForNextLevel, xpProgressInLevel, currentRank,
                                syncId, tempSyncId, setTempSyncId, saveSyncId, clearSyncId, generateRandomCode // Passano naprej
                            })
                        )
                    ),

                    // Navigation
                    React.createElement('nav', { 
                        className: "h-20 flex-none border-t-2 flex justify-around items-center z-30 pb-2 transition-colors duration-500",
                        style: { backgroundColor: 'var(--bg-paper-dark)', borderColor: 'var(--color-accent-dim)' }
                    },
                        React.createElement(NavBtn, { active: activeTab === 'cockpit', onClick: () => setActiveTab('cockpit'), icon: Sword, label: "Delo" }),
                        React.createElement(NavBtn, { active: activeTab === 'vault', onClick: () => setActiveTab('vault'), icon: Scroll, label: "Kronika" }),
                        React.createElement(NavBtn, { active: activeTab === 'barracks', onClick: () => setActiveTab('barracks'), icon: Shield, label: "Vitez" })
                    )
                )
            );
        }

        // --- SUB-COMPONENTS ---
        function NavBtn({ active, onClick, icon, label }) {
            const IconComp = icon;
            return React.createElement('button', { onClick, className: "flex flex-col items-center justify-center w-20 group" },
                React.createElement('div', { className: `transition-all duration-300 transform ${active ? 'scale-110' : 'opacity-50 group-hover:opacity-70'}`, style: { color: active ? 'var(--color-accent)' : 'var(--text-ink)' } }, React.createElement(IconComp, { size: 24, strokeWidth: 1.5 })),
                React.createElement('span', { className: `text-[10px] font-bold uppercase mt-1 tracking-wider ${active ? '' : 'opacity-50'}`, style: { color: active ? 'var(--color-accent)' : 'var(--text-ink)' } }, label)
            );
        }

        function Delavnica({ blocks, onAdd, onRemove, isVictory }) {
            return React.createElement('div', { className: "h-full flex flex-col items-center justify-between py-4" },
                React.createElement('div', { className: "flex flex-col items-center gap-2" },
                    React.createElement('div', { 
                        className: "px-4 py-1 border-2 text-xs font-bold uppercase tracking-[0.2em] rounded-full transition-colors",
                        style: { borderColor: isVictory ? 'var(--color-accent)' : 'var(--color-accent-dim)', color: isVictory ? 'var(--color-accent)' : 'var(--text-ink-light)', backgroundColor: isVictory ? 'var(--color-accent-dim)' : 'transparent' }
                    }, isVictory ? 'Zmaga dneva' : 'V službi kraljestva')
                ),
                React.createElement('div', { className: "relative w-64 h-64 flex items-center justify-center" },
                    React.createElement('div', { className: "absolute inset-0 rounded-full border opacity-20", style: { borderColor: 'var(--text-ink)' } }),
                    React.createElement('div', { className: "absolute inset-4 rounded-full border opacity-20", style: { borderColor: 'var(--text-ink)' } }),
                    React.createElement('div', { className: "flex flex-col items-center z-10" },
                        React.createElement('span', { className: "text-9xl font-serif leading-none", style: { color: 'var(--text-ink)' } }, blocks),
                        React.createElement('div', { className: "h-px w-16 mt-4 mb-2 opacity-30", style: { backgroundColor: 'var(--text-ink)' } }),
                        React.createElement('span', { className: "text-sm font-bold uppercase tracking-[0.2em]", style: { color: 'var(--color-accent)' } }, `${blocks} / ${CILJ_DEL}`),
                        React.createElement('span', { className: "text-[10px] uppercase tracking-widest opacity-50 mt-1", style: { color: 'var(--text-ink)' } }, "Dnevni Cilj")
                    )
                ),
                React.createElement('div', { className: "w-full max-w-xs flex flex-col gap-4" },
                    React.createElement('button', { onClick: onAdd, className: "w-full h-16 rounded border-2 flex items-center justify-center gap-3 shadow-lg active:scale-[0.98] transition-transform", style: { backgroundColor: 'var(--text-ink)', color: 'var(--bg-paper)', borderColor: 'var(--text-ink)' } }, React.createElement(Feather, { size: 20 }), React.createElement('span', { className: "text-lg font-bold tracking-widest uppercase" }, "Zapiši Delo")),
                    React.createElement('button', { onClick: onRemove, disabled: blocks === 0, className: "h-12 flex items-center justify-center gap-2 text-xs font-bold uppercase tracking-widest disabled:opacity-0 transition-colors", style: { color: 'var(--text-ink-light)' } }, React.createElement(Minus, { size: 14 }), "Prekliči zadnjega")
                )
            );
        }

        function Kronika({ history }) {
            const daysToShow = 7;
            const dataPoints = [];
            const today = new Date();
            let maxBlocks = 4;
            for (let i = daysToShow - 1; i >= 0; i--) {
                const d = new Date(); d.setDate(today.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                const val = history[dateStr] || 0;
                if (val > maxBlocks) maxBlocks = val;
                dataPoints.push({ label: getDayName(dateStr), value: val, date: dateStr });
            }
            const generateGridData = () => {
                const historyDates = Object.keys(history).sort();
                const firstHistoryDate = historyDates.length > 0 ? new Date(historyDates[0]) : new Date();
                const fixedStart = new Date('2026-01-01');
                let startDate = firstHistoryDate < fixedStart ? firstHistoryDate : fixedStart;
                const dayOfWeek = startDate.getDay();
                const diffToMon = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                startDate.setDate(startDate.getDate() - diffToMon);
                const endDate = new Date();
                const endDayOfWeek = endDate.getDay();
                const diffToSun = endDayOfWeek === 0 ? 0 : 7 - endDayOfWeek;
                endDate.setDate(endDate.getDate() + diffToSun);
                const grid = [];
                let current = new Date(startDate);
                while (current <= endDate) {
                    const dateStr = current.toISOString().split('T')[0];
                    grid.push({ date: dateStr, value: history[dateStr] || 0, month: current.getMonth(), day: current.getDate(), year: current.getFullYear() });
                    current.setDate(current.getDate() + 1);
                }
                return grid;
            };
            const gridData = generateGridData();
            const weeks = [];
            for (let i = 0; i < gridData.length; i += 7) weeks.push(gridData.slice(i, i + 7));
            const monthNames = ["JAN", "FEB", "MAR", "APR", "MAJ", "JUN", "JUL", "AVG", "SEP", "OKT", "NOV", "DEC"];

            return React.createElement('div', { className: "h-full flex flex-col gap-6" },
                React.createElement('div', { className: "border-b-2 pb-4", style: { borderColor: 'var(--color-accent-dim)' } },
                    React.createElement('h1', { className: "text-3xl font-serif", style: { color: 'var(--text-ink)' } }, "Kronika"),
                    React.createElement('p', { className: "text-sm opacity-60 mt-1 italic" }, "Tvoja pot skozi čas.")
                ),
                React.createElement('div', { className: "p-4 rounded border flex-none", style: { backgroundColor: 'var(--bg-paper-dark)', borderColor: 'var(--color-accent-dim)' } },
                    React.createElement('div', { className: "text-[10px] font-bold uppercase tracking-widest opacity-50 mb-2" }, "Zadnji Teden"),
                    React.createElement('div', { className: "flex items-end justify-between h-24 gap-2" },
                        dataPoints.map((d, i) => {
                            const heightPercent = (d.value / maxBlocks) * 100;
                            const isGoal = d.value >= CILJ_DEL;
                            return React.createElement('div', { key: i, className: "flex-1 flex flex-col items-center gap-1 h-full justify-end" },
                                React.createElement('div', { className: "w-full relative rounded-sm overflow-hidden", style: { height: '100%', backgroundColor: 'var(--color-accent-dim)' } },
                                    React.createElement('div', { className: "absolute bottom-0 left-0 w-full transition-all duration-500", style: { height: `${Math.max(heightPercent, 2)}%`, backgroundColor: isGoal ? 'var(--color-accent)' : 'var(--text-ink)' } })
                                ),
                                React.createElement('div', { className: "text-[8px] font-bold uppercase opacity-50" }, d.label.charAt(0))
                            );
                        })
                    )
                ),
                React.createElement('div', { className: "flex-1 flex flex-col min-h-0" },
                    React.createElement('div', { className: "flex items-center gap-2 mb-2" }, React.createElement(Grid, { size: 14, className: "opacity-50" }), React.createElement('div', { className: "text-[10px] font-bold uppercase tracking-widest opacity-50" }, `Pregled Leta ${new Date().getFullYear()}`) ),
                    React.createElement('div', { className: "flex-1 overflow-x-auto border rounded p-4 scrollbar-thin", style: { backgroundColor: 'var(--bg-paper-dark)', borderColor: 'var(--color-accent-dim)' } },
                        React.createElement('div', { className: "flex gap-1 h-full" },
                            weeks.map((week, wIndex) => {
                                const startOfMonth = week.find(d => d.day === 1);
                                const isMonthChange = startOfMonth !== undefined;
                                return React.createElement('div', { key: wIndex, className: `flex flex-col gap-1 relative ${isMonthChange ? 'ml-1 pl-1 border-l' : ''}`, style: { borderColor: 'var(--color-accent-dim)' } },
                                    isMonthChange && React.createElement('div', { className: "absolute -top-4 left-0 text-[8px] font-bold uppercase tracking-wider whitespace-nowrap", style: { color: 'var(--text-ink)' } }, monthNames[startOfMonth.month]),
                                    week.map((day, dIndex) => {
                                        let bgColor = 'var(--color-accent-dim)';
                                        if (day.value >= 1) bgColor = 'var(--text-ink-light)';
                                        if (day.value >= 3) bgColor = 'var(--color-accent)';
                                        const isEmpty = day.value === 0;
                                        return React.createElement('div', { key: dIndex, className: "w-3 h-3 rounded-[1px] transition-colors", style: { backgroundColor: isEmpty ? 'transparent' : bgColor, border: isEmpty ? '1px solid var(--color-accent-dim)' : 'none' }, title: `${day.date}: ${day.value}` });
                                    })
                                );
                            })
                        )
                    )
                )
            );
        }

        function Vitez({ history, resetDay, selectedDate, currentLevel, totalXP, xpNeededForNextLevel, xpProgressInLevel, currentRank, syncId, tempSyncId, setTempSyncId, saveSyncId, clearSyncId, generateRandomCode }) {
            const percent = Math.floor((xpProgressInLevel / xpNeededForNextLevel) * 100);
            const IconComp = currentRank.icon;

            return React.createElement('div', { className: "h-full flex flex-col overflow-y-auto" },
                React.createElement('div', { className: "border-b-2 pb-4 mb-6", style: { borderColor: 'var(--color-accent-dim)' } },
                    React.createElement('h1', { className: "text-3xl font-serif", style: { color: 'var(--text-ink)' } }, "Vitez")
                ),
                React.createElement('div', { className: "flex flex-col items-center gap-2 mb-8 p-6 rounded border transition-colors duration-500", style: { backgroundColor: 'var(--bg-paper-dark)', borderColor: 'var(--color-accent-dim)' } },
                    React.createElement('div', { className: "w-24 h-24 rounded-full border-2 flex items-center justify-center mb-2 shadow-inner", style: { backgroundColor: 'var(--bg-paper)', borderColor: 'var(--color-accent-dim)' } },
                        React.createElement('div', { style: { color: 'var(--color-accent)', transform: 'scale(2)' } }, React.createElement(IconComp, { size: 20 }))
                    ),
                    React.createElement('h2', { className: "text-2xl font-bold uppercase tracking-wide", style: { color: 'var(--text-ink)' } }, currentRank.title),
                    React.createElement('p', { className: "text-sm opacity-60 font-serif italic" }, `Stopnja ${currentLevel}`),
                    React.createElement('div', { className: "w-full mt-4" },
                        React.createElement('div', { className: "flex justify-between text-[10px] font-bold uppercase tracking-widest opacity-60 mb-1" },
                            React.createElement('span', null, `${xpProgressInLevel} XP`),
                            React.createElement('span', null, `${xpNeededForNextLevel} XP`)
                        ),
                        React.createElement('div', { className: "h-2 w-full rounded-full overflow-hidden", style: { backgroundColor: 'var(--color-accent-dim)' } },
                            React.createElement('div', { className: "h-full transition-all duration-500", style: { width: `${percent}%`, backgroundColor: 'var(--color-accent)' } })
                        ),
                        React.createElement('div', { className: "text-center text-[10px] mt-1 opacity-50" }, `Do naslednje stopnje: ${xpNeededForNextLevel - xpProgressInLevel} XP`)
                    )
                ),
                
                // SYNC SECTION
                React.createElement('div', { className: "mb-8 p-4 rounded border", style: { borderColor: 'var(--color-accent-dim)', backgroundColor: 'var(--bg-paper-dark)' } },
                    React.createElement('div', { className: "flex items-center gap-2 mb-3" },
                        React.createElement(Link, { size: 16, style: { color: 'var(--color-accent)' } }),
                        React.createElement('h3', { className: "text-xs font-bold uppercase tracking-widest opacity-80" }, "Povezava Naprav")
                    ),
                    
                    !syncId ? (
                        React.createElement('div', { className: "flex flex-col gap-2" },
                            React.createElement('div', { className: "flex gap-2" },
                                React.createElement('input', { 
                                    type: "text", 
                                    placeholder: "Vnesi poljubno ime...", 
                                    value: tempSyncId,
                                    onChange: (e) => setTempSyncId(e.target.value),
                                    className: "flex-1 p-2 rounded text-sm border bg-white/50 focus:outline-none focus:border-opacity-100",
                                    style: { borderColor: 'var(--color-accent-dim)' }
                                }),
                                React.createElement('button', { 
                                    onClick: saveSyncId,
                                    className: "p-2 rounded text-white shadow-sm",
                                    style: { backgroundColor: 'var(--color-accent)' }
                                }, React.createElement(Save, { size: 16 }))
                            ),
                            // GUMB ZA GENERIRANJE KODE
                            React.createElement('button', {
                                onClick: generateRandomCode,
                                className: "text-[10px] uppercase font-bold underline opacity-60 hover:opacity-100 self-start flex items-center gap-1",
                                style: { color: 'var(--text-ink)' }
                            }, React.createElement(RefreshCw, { size: 10 }), "Generiraj varno kodo")
                        )
                    ) : (
                        React.createElement('div', { className: "flex justify-between items-center bg-white/20 p-2 rounded" },
                            React.createElement('div', { className: "text-sm" }, 
                                React.createElement('span', { className: "opacity-50 text-xs block" }, "Povezan kot:"),
                                React.createElement('strong', { style: { color: 'var(--color-accent)' } }, syncId)
                            ),
                            React.createElement('button', { 
                                onClick: clearSyncId,
                                className: "text-xs underline opacity-50 hover:opacity-100"
                            }, "Odjavi")
                        )
                    ),
                    React.createElement('p', { className: "text-[10px] opacity-50 mt-2 leading-tight" }, "Vpiši isto ime na telefonu in računalniku za sinhronizacijo podatkov.")
                ),

                React.createElement('div', { className: "mb-8" },
                    React.createElement('div', { className: "flex items-center gap-2 mb-2 px-2" },
                        React.createElement(Star, { size: 14, className: "opacity-50" }),
                        React.createElement('h3', { className: "text-xs font-bold uppercase tracking-widest opacity-50" }, "Trenutni Zavetnik")
                    ),
                    React.createElement('div', { className: "p-4 rounded text-sm leading-relaxed font-serif mb-6 border", style: { backgroundColor: 'var(--bg-paper)', borderColor: 'var(--color-accent)', color: 'var(--text-ink)' } },
                        React.createElement('div', { className: "flex items-center gap-3 mb-2" },
                            React.createElement('div', { style: { color: 'var(--color-accent)' } }, React.createElement(IconComp, { size: 20 })),
                            React.createElement('strong', { className: "text-lg", style: { color: 'var(--color-accent)' } }, currentRank.saint)
                        ),
                        React.createElement('p', { className: "italic opacity-80" }, `"${currentRank.saintDesc}"`)
                    ),
                    React.createElement('div', { className: "flex items-center gap-2 mb-2 px-2" },
                        React.createElement(HelpCircle, { size: 14, className: "opacity-50" }),
                        React.createElement('h3', { className: "text-xs font-bold uppercase tracking-widest opacity-50" }, "Kodeks Igre")
                    ),
                    React.createElement('div', { className: "p-4 rounded text-sm leading-relaxed font-serif border", style: { backgroundColor: 'var(--bg-paper-dark)', borderColor: 'var(--color-accent-dim)', color: 'var(--text-ink)' } },
                        React.createElement('p', { className: "mb-2" }, React.createElement('strong', { style: { color: 'var(--color-accent)' } }, "1 Delo = 100 XP.")),
                        React.createElement('p', { className: "mb-4" }, "Vsak zabeležen blok dela ti prinese točke izkušenj."),
                        React.createElement('div', { className: "border-t pt-4 mt-4", style: { borderColor: 'var(--color-accent-dim)' } },
                            React.createElement('strong', { className: "text-xs font-bold uppercase opacity-70 block mb-3" }, "Hierarhija in Svetniki"),
                            React.createElement('ul', { className: "space-y-3 text-xs opacity-90" },
                                RANK_SYSTEM.map((rank, i) => {
                                    const isActive = currentLevel >= rank.minLevel && (i === RANK_SYSTEM.length - 1 || currentLevel < RANK_SYSTEM[i+1].minLevel);
                                    return React.createElement('li', { key: i, className: `flex flex-col pb-2 ${i !== RANK_SYSTEM.length - 1 ? 'border-b' : ''}`, style: { borderColor: 'var(--color-accent-dim)' } },
                                        React.createElement('div', { className: "flex justify-between items-center mb-1" },
                                            React.createElement('span', { className: `font-bold uppercase ${isActive ? 'text-lg' : ''}`, style: { color: isActive ? 'var(--color-accent)' : 'var(--text-ink)' } }, rank.title),
                                            React.createElement('span', { className: "opacity-60" }, `Lvl ${rank.minLevel}+`)
                                        ),
                                        React.createElement('div', { className: "flex items-center gap-2 opacity-80" },
                                            React.createElement('span', { style: { color: isActive ? 'var(--color-accent)' : 'var(--text-ink-light)' } }, rank.saint)
                                        )
                                    );
                                })
                            )
                        )
                    )
                ),
                React.createElement('div', { className: "mt-auto border-t-2 pt-6", style: { borderColor: 'var(--color-accent-dim)' } },
                    React.createElement('div', { className: "flex justify-between items-center mb-4 text-xs font-bold uppercase tracking-widest opacity-50" },
                        React.createElement('span', null, "Urejanje Dneva"),
                        React.createElement('span', null, formatDateShort(selectedDate))
                    ),
                    React.createElement('button', {
                        onClick: resetDay,
                        className: "w-full py-4 border rounded text-xs font-bold uppercase tracking-widest transition-colors hover:opacity-80",
                        style: { borderColor: 'var(--color-accent)', color: 'var(--color-accent)' }
                    }, "Počisti izbran dan")
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(DeepFocusMedieval));
    </script>
</body>
</html>
